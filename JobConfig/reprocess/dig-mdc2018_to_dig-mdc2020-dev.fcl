# Update MDC2018 digi files to MDC2020-dev files so that people
# can continue development work
#
# A. Edmonds Jan 2020

#include "JobConfig/mixing/prolog.fcl"

process_name : ReprocessMDC2018

source : {
  module_type : RootInput
  fileNames   : @nil
  inputCommands : ["keep *",
		"drop mu2e::StrawDigis_*_*_*",
		"drop mu2e::StrawDigiMCs_*_*_*"]
# don't follow art's rule on branch 'dependencies'
  dropDescendantsOfDroppedBranches: false
}

services: @local::Services.Sim

physics : { 
  producers : {
    @table::Mixing.producers

    # some older digis (MDC2018f and earlier) have an off-by-one error in the caloShowerSteps
    CaloFix : { @table::DigiCompression.CaloFix 
        caloShowerStepTags : [ "compressDigiMCs" ]
        caloShowerSimTag : "compressDigiMCs"
        caloShowerStepROTag : "compressDigiMCs"
    }

  }
  analyzers: { @table::Mixing.analyzers 
  }

  TriggerPath : [ CaloFix,
  	      	  @sequence::TrackerMC.DigiSim,
		  compressDigiMCs
		]

  EndPath : [ @sequence::Mixing.EndPath ]
}

outputs: { Output : @local::Mixing.Output }

# some older digis don't have cosmicTimeMaps
physics.producers.makeSD.TimeOffsets : [ "compressDigiMCs:protonTimeMap:CeEndpointMix", "compressDigiMCs:muonTimeMap:CeEndpointMix"]
# cosmicTimeMap

physics.producers.compressDigiMCs.simParticleTags : [ "compressDigiMCs::CeEndpointMix" ]
physics.producers.compressDigiMCs.crvDigiMCTag : "compressDigiMCs::CeEndpointMix"

#physics.producers.compressDigiMCs.caloShowerStepTags : [ "compressDigiMCs::CeEndpointMix" ]
#physics.producers.compressDigiMCs.caloShowerSimTag : "compressDigiMCs::CeEndpointMix"
#physics.producers.compressDigiMCs.caloShowerStepROTag : "compressDigiMCs::CeEndpointMix"
physics.producers.compressDigiMCs.caloShowerStepTags : [ "CaloFix" ]
physics.producers.compressDigiMCs.caloShowerSimTag : "CaloFix"
physics.producers.compressDigiMCs.caloShowerStepROTag : "CaloFix"

# some older digi files didn't keep the MCTrajectory objects
# there's nothing we can do about this now
physics.producers.compressDigiMCs.mcTrajectoryTag : ""

physics.producers.compressDigiMCs.extraStepPointMCTags : [ "compressDigiMCs:virtualdetector:CeEndpointMix", "compressDigiMCs:protonabsorber:CeEndpointMix" ]
physics.producers.compressDigiMCs.timeMapTags : [ "compressDigiMCs:protonTimeMap:CeEndpointMix", "compressDigiMCs:muonTimeMap:CeEndpointMix"]

physics.analyzers.digiCompressionCheck.oldStrawDigiMCTag : "compressDigiMCs::CeEndpointMix"
physics.analyzers.digiCompressionCheck.newStrawDigiMCTag : "compressDigiMCs::current_process"
physics.analyzers.digiCompressionCheck.OldTimeOffsets : { inputs : [ "compressDigiMCs:protonTimeMap:CeEndpointMix", "compressDigiMCs:muonTimeMap:CeEndpointMix"  ] }
physics.analyzers.digiCompressionCheck.NewTimeOffsets : { inputs : [ "compressDigiMCs:protonTimeMap:current_process", "compressDigiMCs:muonTimeMap:current_process" ] }
#physics.analyzers.digiCompressionCheck.oldCaloShowerSimTag : "compressDigiMCs::CeEndpointMix"
physics.analyzers.digiCompressionCheck.oldCaloShowerSimTag : "CaloFix"
physics.analyzers.digiCompressionCheck.newCaloShowerSimTag : "compressDigiMCs::current_process"
physics.analyzers.digiCompressionCheck.oldCrvDigiMCTag : "compressDigiMCs::CeEndpointMix"
physics.analyzers.digiCompressionCheck.newCrvDigiMCTag : "compressDigiMCs::current_process"

# customize the output
services.TFileService.fileName: "out/nts.owner.ReprocessTest.version.sequencer.root"
outputs.Output.fileName: "out/dig.owner.ReprocessTest.version.sequencer.art"
outputs.Output.outputCommands : [ "keep *_*_*_*", 
			      	  "drop *_compressDigiMCs_*_CeEndpointMix",
				  "drop *_CaloFix_*_*"
				]

physics.end_paths : [ EndPath ] # needed for generate_fcl

# test values; these get overwritten by generate_fcl
services.SeedService.baseSeed         :  773651
services.SeedService.maxUniqueEngines :  20

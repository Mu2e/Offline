/* A lowchart showing the simulation workflow for Mu2e.
 * To compile:
 *
 *     dot -Ttiff SimulationWorkflow.dot -o SimulationWorkflow.tiff
 *
 */

digraph SimWorkflow {
  /* size="14,11"; */
  label = "Mu2e Simulation Workflow";
  fontname="Helvetica";
  fontsize="36";
  labelloc = t;

  subgraph clusterLegend {
    rankdir=TB;
    color="red";
    label="Legend";
    Job [shape=box,color=blue,
	label=<<table border="0" cellborder="0" cellspacing="1">
	  <tr><td align="center"><b>Job</b></td></tr>
	  <tr><td align="left"><font color="darkgreen">fhicl file</font></td></tr>
	  </table>>];

    Dataset [shape=oval, color=lightblue,
	    label=<<table border="0" cellborder="0" cellspacing="1">
	      <tr><td align="center"><b>Dataset</b></td></tr>
	      <tr><td align="left"><font color="red">SAM name</font></td></tr>
	      </table>>];

    Dataset -> Job [style=dashed, label="Mixin"];
    Dataset -> Job [style=solid, label="Main"];
  }

  subgraph Campaign {

    POT [shape=box,color=blue,
	label=<<table border="0" cellborder="0" cellspacing="1">
	  <tr><td align="center"><b>Protons On Target</b></td></tr>
	  <tr><td align="left"><font color="darkgreen">beam/POT.fcl</font></td></tr>
	  </table>>];
    Beam [shape=oval,color=lightblue,
	 label=<<table border="0" cellborder="0" cellspacing="1">
	   <tr><td align="center"><b>Meson Beam</b></td></tr>
	   <tr><td align="left"><font color="red">sim.mu2e.MuBeam.art</font></td></tr>
	   <tr><td align="left"><font color="yellow">sim.mu2e.PiBeam.art</font></td></tr>
	   </table>>];
    Flash [shape=oval, color=lightblue,
	      label=<<table border="0" cellborder="0" cellspacing="1">
		<tr><td align="center"><b>Flash</b></td></tr>
		<tr><td align="left"><font color="red">sim.mu2e.FlashBeam.art</font></td></tr>
		</table>>];
    EarlyFlash [shape=oval, color=lightblue,
	       label=<<table border="0" cellborder="0" cellspacing="1">
		 <tr><td align="center"><b>Early Flash</b></td></tr>
		 <tr><td align="left"><font color="red">sim.mu2e.EarlyFlashBeam.art</font></td></tr>
		 </table>>];

    POT -> Flash [ label="At TS5 + CRV, t > 300? ns"];
    POT ->  Beam [ label="At TS5"];
    POT ->  EarlyFlash [ label=< At TS5 + CRV, 300 &gt; t &gt; 0 ns, prescale 10<sup>-4</sup>?> ];

    EarlyFlashResampling [shape=box,color=blue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b>Early Flash Resampling</b></td></tr>
		      <tr><td align="left"><font color="darkgreen">pileup/EarlyFlashResampler.fcl</font></td></tr>
		      </table>>];

    FlashResampling [shape=box,color=blue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b>Flash Resampling</b></td></tr>
		      <tr><td align="left"><font color="darkgreen">pileup/FlashResampler.fcl</font></td></tr>
		      </table>>];

    StopPositionResampling [shape=box,color=blue,
			   label=<<table border="0" cellborder="0" cellspacing="1">
			     <tr><td align="center"><b>Particle Stopper</b></td></tr>
			     <tr><td align="left"><font color="darkgreen">beam/ParticleStopper.fcl</font></td></tr>
			     </table>>];

    Beam -> StopPositionResampling [ label=<resample 10<sup>+4</sup>?> ];
    Flash -> FlashResampling [ label=<t &gt; 450 ns, resample 10<sup>+4</sup>?> ];
    EarlyFlash -> EarlyFlashResampling [ label=<tracker only, resample 10<sup>+4</sup>?> ];

    EarlyFlashPileup [shape=oval, color=lightblue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b>Early Flash Pileup</b></td></tr>
		      <tr><td align="left"><font color="red">dts.mu2e.EarlyFlash.art</font></td></tr>
		      </table>>];

    FlashPileup [shape=oval, color=lightblue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b>Flash Pileup</b></td></tr>
		      <tr><td align="left"><font color="red">dts.mu2e.Flash.art</font></td></tr>
		      </table>>];

    TargetStops [shape=oval, color=lightblue,
		label=<<table border="0" cellborder="0" cellspacing="1">
		  <tr><td align="center"><b>Target Stops</b></td></tr>
		  <tr><td align="left"><font color="red">sim.mu2e.MuTargetStops.art</font></td></tr>
		  <tr><td align="left"><font color="yellow">sim.mu2e.PiTargetStops.art</font></td></tr>
		  </table>>];

    OutOfTargetStops [shape=oval, color=lightblue,
		     label=<<table border="0" cellborder="0" cellspacing="1">
		       <tr><td align="center"><b>Out Of Target (OOT) Stops</b></td></tr>
		       <tr><td align="left"><font color="red">sim.mu2e.MuOOTStops.art</font></td></tr>
		       </table>>];

    IPAStops [shape=oval, color=lightblue,
	     label=<<table border="0" cellborder="0" cellspacing="1">
	       <tr><td align="center"><b>IPA Stops</b></td></tr>
	       <tr><td align="left"><font color="red">sim.mu2e.IPAStops.art</font></td></tr>
	       </table>>];

    FlashResampling -> FlashPileup;
    EarlyFlashResampling -> EarlyFlashPileup [ label=<selected straws> ];

    StopPositionResampling -> TargetStops;
    StopPositionResampling -> OutOfTargetStops;
    StopPositionResampling -> IPAStops;

    PrimaryMuonTerm [shape=box, peripheries=3, color=blue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b>&mu; on Al to X &isin; [Ce<sup>-</sup>, Ce<sup>+</sup>, DIO Tail, Internal RPC, ...] </b></td></tr>
		      <tr><td align="left"><font color="darkgreen">primary/X.fcl, X &isin; [CeMinus, CePlus, DIOTail, ...]</font></td></tr>
		      </table>>];

    PileupMuonTerm [shape=box,color=blue,
		       label=<<table border="0" cellborder="0" cellspacing="1">
			 <tr><td align="center"><b>&mu; to X &isin; [P, D, N,&gamma;, e &nu;]  </b></td></tr>
			 <tr><td align="left"><font color="darkgreen">pileup/mustop.fcl</font></td></tr>
			 </table>>];

    OutOfTargetMuonTerm [shape=box,color=blue,
			label=<<table border="0" cellborder="0" cellspacing="1">
			  <tr><td align="center"><b>OOT &mu; decay (G4)</b></td></tr>
			  <tr><td align="left"><font color="darkgreen">pileup/OOTmustop.fcl</font></td></tr>
			  </table>>];

    IPAMuonTerm [shape=box,color=blue,
		label=<<table border="0" cellborder="0" cellspacing="1">
		  <tr><td align="center"><b>IPA Muon Termination</b></td></tr>v
		  <tr><td align="left"><font color="darkgreen">primary/IPAmustop.fcl</font></td></tr></table>>];

    TargetStops -> PrimaryMuonTerm [ label=<resample 10<sup>+3</sup>?> ];
    TargetStops -> PileupMuonTerm [ label=<resample 10<sup>+3</sup>?> ];
    OutOfTargetStops -> OutOfTargetMuonTerm [ label=<resample 10<sup>+3</sup>?> ];
    IPAStops -> IPAMuonTerm [ label=<resample 10<sup>+3</sup>?> ];

    CosmicStage0 [shape=box, peripheries=1, color=blue,
            label=<<table border="0" cellborder="0" cellspacing="1">
                        <tr><td align="center"><b>CORSIKA executable</b></td></tr>
                        <tr><td align="left">./corsika77400Linux_QGSJET_fluka &lt; input_configuration</td></tr>
                        </table>>];

    CORSIKAOutput [shape=oval, peripheries=1, color=lightblue,
		  label=<<table border="0" cellborder="0" cellspacing="1">
		    <tr><td align="center"><b>CORSIKA binaries</b></td></tr>
		    <tr><td align="left"><font color="red">sim.mu2e.CORSIKA.csk</font></td></tr>
		    </table>>];

    CosmicStage0 -> CORSIKAOutput;

    CosmicGenerator [shape=box, peripheries=3, color=blue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b>CORSIKA, CRY, ... generation</b></td></tr>
		      <tr><td align="left"><font color="darkgreen">cosmic/cosmic_s1_dsstops_X.fcl, X &isin; [CORSIKA, CRY, ...]</font></td></tr>
		      </table>>];

    CORSIKAOutput -> CosmicGenerator;

    CosmicStage1Output [shape=oval, peripheries=3, color=lightblue,
		  label=<<table border="0" cellborder="0" cellspacing="1">
		    <tr><td align="center"><b>Cosmic generation output</b></td></tr>
		    <tr><td align="left"><font color="red">sim.mu2e.CosmicDSStopsX.art, X &isin; [CORSIKA, CRY, ...]</font></td></tr>
		    </table>>];

    CosmicGenerator -> CosmicStage1Output;

    CosmicStage2 [shape=box, peripheries=3, color=blue,
        label=<<table border="0" cellborder="0" cellspacing="1">
            <tr><td align="center"><b>Cosmic resampling</b></td></tr>
            <tr><td align="left"><font color="darkgreen">cosmic/cosmic_s2_resampler_X.fcl, X &isin; [hi, lo]</font></td></tr>
            </table>>];

    CosmicStage1Output -> CosmicStage2;

    CosmicPrimary [shape=oval, peripheries=3, color=lightblue,
		  label=<<table border="0" cellborder="0" cellspacing="1">
		    <tr><td align="center"><b>Cosmic Ray Primary</b></td></tr>
		    <tr><td align="left"><font color="red">dts.mu2e.X.art, X &isin; [CORSIKA, CRY, ...]</font></td></tr>
		    </table>>];

    IPAPrimary [shape=oval, color=lightblue,
	       label=<<table border="0" cellborder="0" cellspacing="1">
		 <tr><td align="center"><b>IPA Muon Primary</b></td></tr>
		 <tr><td align="left"><font color="red">dts.mu2e.IPAmu.art </font></td></tr>
		 </table>>];

    MuonPrimary [shape=oval, peripheries=3, color=lightblue,
		label=<<table border="0" cellborder="0" cellspacing="1">
		  <tr><td align="center"><b>Target Muon Primary</b></td></tr>
		  <tr><td align="left"><font color="red">dts.mu2e.X.art, X &isin;[CeMinus, CePlus, ...] </font></td></tr>
		  </table>>];

    CosmicStage2 -> CosmicPrimary;
    PrimaryMuonTerm -> MuonPrimary;
    IPAMuonTerm -> IPAPrimary;
    {rank=same CosmicStage1Output IPAStops};

    CosmicPrimary [shape=oval, peripheries=3, color=lightblue,
		  label=<<table border="0" cellborder="0" cellspacing="1">
		    <tr><td align="center"><b>Cosmic Ray Primary</b></td></tr>
		    <tr><td align="left"><font color="red">dts.mu2e.X.art, X &isin; [CORSIKA, CRY, ...] </font></td></tr>
		    </table>>];

    TargetMuonPileup [shape=oval, color=lightblue,
			 label=<<table border="0" cellborder="0" cellspacing="1">
			   <tr><td align="center"><b>Target Muon Pileup </b></td></tr>
			   <tr><td align="left"><font color="red">dts.mu2e.mu.art</font></td></tr>
			   </table>>];

    OutOfTargetMuonPileup [shape=oval, color=lightblue,
			      label=<<table border="0" cellborder="0" cellspacing="1">
				<tr><td align="center"><b>Out Of Target Muon Pileup </b></td></tr>
				<tr><td align="left"><font color="red">dts.mu2e.ootmu.art</font></td></tr>
				</table>>];

    PileupMuonTerm -> TargetMuonPileup;
    OutOfTargetMuonTerm -> OutOfTargetMuonPileup;
    {rank=same TargetMuonPileup OutOfTargetMuonPileup EarlyFlashPileup FlashPileup CosmicPrimary MuonPrimary IPAPrimary};

    MixDigitization [shape=box, peripheries=1, color=blue,
		    label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b> Primary + Pileup Digitization </b></td></tr>
		      <tr><td align="left"><font color="darkgreen">mixing/mix.fcl</font></td></tr>
		      </table>>];

    NomixDigitization [shape=box, peripheries=1, color=blue,
		      label=<<table border="0" cellborder="0" cellspacing="1">
		      <tr><td align="center"><b> Primary Only Digitization </b></td></tr>
		      <tr><td align="left"><font color="darkgreen">digitize/OnSpill.fcl</font></td></tr>
		      <tr><td align="left"><font color="darkgreen">digitize/OffSpill.fcl</font></td></tr>
		      </table>>];

    MuonPrimary -> MixDigitization;
    CosmicPrimary -> MixDigitization;
    IPAPrimary -> MixDigitization;
    TargetMuonPileup -> MixDigitization [style=dashed, label=<resample 10<sup>+4</sup>?> ];
    OutOfTargetMuonPileup -> MixDigitization [style=dashed, label=<resample 10<sup>+4</sup>?>];
    EarlyFlashPileup -> MixDigitization [style=dashed, label=<resample 10<sup>+4</sup>?>];
    FlashPileup -> MixDigitization [style=dashed, label=<resample 10<sup>+4</sup>?>];

    MuonPrimary -> NomixDigitization;
    CosmicPrimary -> NomixDigitization;
    IPAPrimary -> NomixDigitization;

    UnmixedDigis [shape=oval, peripheries=3, color=lightblue,
		 label=<<table border="0" cellborder="0" cellspacing="1">
		   <tr><td align="center"><b>Unmixed Digis</b></td></tr>
		   <tr><td align="left"><font color="red">dig.mu2e.X.art, X &isin; [CeMinus, Corsika, ...]</font></td></tr>
		   </table>>];

    MixedDigis [shape=oval, peripheries=3, color=lightblue,
	       label=<<table border="0" cellborder="0" cellspacing="1">
		 <tr><td align="center"><b>Mixed Digis</b></td></tr>
		 <tr><td align="left"><font color="red">dig.mu2e.XMix.art, X &isin; [CeMinus, Corsika, ...]</font></td></tr>
		 </table>>];

    NomixDigitization -> UnmixedDigis;
    MixDigitization -> MixedDigis;

    {rank=same NomixDigitization MixDigitization};

    Reconstruction [shape=box, peripheries=1, color=blue,
		   label=<<table border="0" cellborder="0" cellspacing="1">
		     <tr><td align="center"><b> Reconstruction </b></td></tr>
		     <tr><td align="left"><font color="darkgreen">reco/reco.fcl </font></td></tr>
		     </table>>];

    Reco [shape=oval, color=lightblue, peripheries=3
	 label=<<table border="0" cellborder="0" cellspacing="1">
	   <tr><td align="center"><b>Reconstructed Events (Tracks, CaloClusters, CRVClusters, ...)</b></td></tr>
	   <tr><td align="left"><font color="red">mcs.mu2e.X.art, X &isin; [CeMinus, Corsika, ...]</font></td></tr>
	   </table>>];

    MixedDigis -> Reconstruction
      UnmixedDigis -> Reconstruction
      Reconstruction -> Reco

  }
}

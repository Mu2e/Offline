# Run trigger, add MC truth matching, and write TrkAna tree output
# To create a functional job you must add database purpose and version; ie create a fcl stub that #includes this file and
# adds (for instance):
# services.DbService.purpose: MDC2020_perfect
# services.DbService.version: v1_0
#
#include "Offline/fcl/standardServices.fcl"
#include "Offline/Trigger/fcl/prolog_trigger.fcl"
#include "Offline/CommonMC/fcl/prolog_trigger.fcl"
#include "TrkAna/fcl/prolog_trigger.fcl"
process_name : OnSpillTrigger
services : @local::Services.Reco
source : {
  module_type : RootInput
  inputCommands: ["keep *",
    "drop mu2e::HelixSeeds_*_*_*",
    "drop mu2e::KalSeeds_*_*_*",
    "drop mu2e::TriggerInfo_*_*_*",
    "drop mu2e::CaloClusters_*_*_*",
    "drop mu2e::TimeClusters_*_*_*"
  ]
}

physics : {
  producers : {
    @table::Trigger.producers
    SelectRecoMCDeMcpr : {
      @table::CommonMCTrigger.TTSelectRecoMC
      KalSeedCollections  : [ "TTCalSeedFitDem" ]
      HelixSeedCollections  : ["TTCalHelixMergerDeM" ]
    }
    SelectRecoMCDeMtpr : {
      @table::CommonMCTrigger.TTSelectRecoMC
      KalSeedCollections  : [ "TTKSFDeM" ]
      HelixSeedCollections  : ["TTHelixMergerDeM" ]
    }
    SelectRecoMCDePcpr : {
      @table::CommonMCTrigger.TTSelectRecoMC
      KalSeedCollections  : [ "TTCalSeedFitDep" ]
      HelixSeedCollections  : ["TTCalHelixMergerDeP" ]
    }
    SelectRecoMCDePtpr : {
      @table::CommonMCTrigger.TTSelectRecoMC
      KalSeedCollections  : [ "TTKSFDeP" ]
      HelixSeedCollections  : ["TTHelixMergerDeP" ]
    }
  }
  filters :  { @table::Trigger.filters }
  analyzers : {
    @table::Trigger.analyzers
    TADeMtpr : {
      @table::TrkAnaTrigger.TrkAnaDeMTT
      FitType : LoopHelix
    }

    TADeMcpr : {
      @table::TrkAnaTrigger.TrkAnaDeMTT
      FitType : LoopHelix
    }
    TADePtpr : {
      @table::TrkAnaTrigger.TrkAnaDePTT
      FitType : LoopHelix
    }
    TADePcpr : {
      @table::TrkAnaTrigger.TrkAnaDePTT
      FitType : LoopHelix
    }
  }
  EndPath : [TADeMtpr, TADeMcpr, TADePtpr, TADePcpr]
}
#include "Offline/gen/fcl/Trigger/OnSpillTrigMenu/OnSpillTrigMenu.fcl"
physics.producers.EWMProducer.SpillType : 1
#include "Production/JobConfig/common/epilog.fcl"
physics.end_paths : [ EndPath ]
# add MC truth matching to the relevant paths
physics.tprDeM_highP_stopTarg_trigger           : [ @sequence::physics.tprDeM_highP_stopTarg_trigger, SelectRecoMCDeMtpr]
physics.cprDeM_highP_stopTarg_trigger           : [ @sequence::physics.cprDeM_highP_stopTarg_trigger, SelectRecoMCDeMcpr]
physics.tprDeP_highP_stopTarg_trigger           : [ @sequence::physics.tprDeP_highP_stopTarg_trigger, SelectRecoMCDePtpr]
physics.cprDeP_highP_stopTarg_trigger           : [ @sequence::physics.cprDeP_highP_stopTarg_trigger, SelectRecoMCDePcpr]

physics.analyzers.TADeMtpr.SelectEvents : [  tprDeM_highP_stopTarg_trigger  ]
physics.analyzers.TADeMtpr.candidate.input : "TTKSF"
physics.analyzers.TADeMtpr.candidate.suffix : "DeM"
physics.analyzers.TADeMtpr.KalSeedMCAssns: "SelectRecoMCDeMtpr"

physics.analyzers.TADeMcpr.SelectEvents : [  cprDeM_highP_stopTarg_trigger  ]
physics.analyzers.TADeMcpr.candidate.input : "TTCalSeedFit"
physics.analyzers.TADeMcpr.candidate.suffix : "Dem"
physics.analyzers.TADeMcpr.KalSeedMCAssns: "SelectRecoMCDeMcpr"

physics.analyzers.TADePtpr.SelectEvents : [  tprDeP_highP_stopTarg_trigger  ]
physics.analyzers.TADePtpr.candidate.input : "TTKSF"
physics.analyzers.TADePtpr.candidate.suffix : "DeP"
physics.analyzers.TADePtpr.KalSeedMCAssns: "SelectRecoMCDePtpr"

physics.analyzers.TADePcpr.SelectEvents : [  cprDeP_highP_stopTarg_trigger  ]
physics.analyzers.TADePcpr.candidate.input : "TTCalSeedFit"
physics.analyzers.TADePcpr.candidate.suffix : "Dep"
physics.analyzers.TADePcpr.KalSeedMCAssns: "SelectRecoMCDePcpr"

# this next is currently needed to get correct hit-level MC truth matching.  It needs to be fixed at the
# ComboHitCollection.  This setting works, but will slow down the trigger: don't use this script for timing studies
physics.producers.TTmakeSH.FilterHits : false
physics.producers.TTmakePH.TestFlag : true
#physics.producers.TTmakePH.FilterHits : true
physics.producers.TTmakePH.StrawHitSelectionBits : ["EnergySelection","TimeSelection","RadiusSelection"]
physics.producers.TTmakePH.StrawHitMask          : ["Dead","Noisy"]

services.TimeTracker.printSummary: true
services.TFileService.fileName: "nts.owner.TTKKSeed.version.sequence.root"
